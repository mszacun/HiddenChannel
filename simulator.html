<html>
    <head>
        <script src="simulator.js"></script>
        <link rel="stylesheet" href="font-awesome-4.3.0/css/font-awesome.min.css">
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="simulator.css" />

        <script src="symulator/lib/jquery.js"></script>
        <script src="symulator/lib/lodash.js"></script>
        <script src="symulator/lib/backbone.js"></script>
        <script src="symulator/lib/datatables/datatables.min.js"></script>
        <script src="symulator/lib/metro/metro.min.js"></script>
        <script src="symulator/models.js"></script>
        <script src="symulator/symulator.js"></script>



        <script>
            $(document).ready(function() {
                var queue1 = new Queue($('#source .queue'));
                var queue2 = new Queue($('#destination .queue'));
                var link = new Link($('#link'));
                var hiddenQueue = new HiddenMessageQueue($('#hidden-message-queue'));
                var symulator = new Symulator({symulationTime: 15});

                function wait(time) {
                    var deferred = new $.Deferred();

                    setTimeout(function() {
                        deferred.resolve();
                    }, time);

                    return deferred.promise();
                }

                function symulationStep() {
                    var events = symulator.step();

                    return $.when(
                        addBasicMessages(events.arrivedBasicMessages)
                            .then(function() { return addHiddenMessages(events.arrivedHiddenMessages); })
                            .then(function() { return createAndSendPackets(events.packetsGenerated, events.packetsThatReachedTarget); }),
                        wait(1500));
                }

                function addBasicMessages(basicMessages) {
                    var deferred = new $.Deferred();

                    if (basicMessages.length == 0)
                        deferred.resolve();
                    else {
                        var promise = queue1.addMessageOnTop(basicMessages[0].length)
                        _.each(_.rest(basicMessages), function(message) {
                            promise = promise.then(function() {
                                return queue1.addMessageOnTop(message.length);
                            });
                        });
                        promise.then(function() {
                            deferred.resolve();
                        });
                    }
                    return deferred;
                }

                function addHiddenMessages(hiddenMessages) {
                    var deferred = new $.Deferred();

                    if (hiddenMessages.length == 0)
                        deferred.resolve();
                    else {
                        var promise = hiddenQueue.addOnTheRight(hiddenMessages[0].segments)
                        _.each(_.rest(hiddenMessages), function(message) {
                            promise = promise.then(function() {
                                return hiddenQueue.addOnTheRight(message.segments);
                            });
                        });
                        promise.then(function() {
                            deferred.resolve();
                        });
                    }
                    return deferred;
                }

                function createAndSendPackets(packetsGenerated, packetsThatReachedTarget) {
                    var deferred = new $.Deferred();

                    if (packetsGenerated.length == 0)
                        deferred.resolve();
                    else {
                        var hasReached = _.find(packetsThatReachedTarget, {cid: packetsGenerated[0].cid});
                        var promise = createAndSendPacket(packetsGenerated[0], hasReached);
                        _.each(_.rest(packetsGenerated), function(message) {
                            var hasReached = _.find(packetsThatReachedTarget, {cid: message.cid});
                            promise = promise.then(function() {
                                return createAndSendPacket(message, hasReached);
                            });
                        });
                        promise.then(function() {
                            deferred.resolve();
                        });
                    }

                    return deferred.promise();
                }

                function createAndSendPacket(packet, hasReached) {
                    var promise = undefined;
                    var sizeWithoutHeader = packet.getSizeWithoutHeader();
                    if (packet.get('hasHiddenData')) {
                        promise = $.when(
                            queue1.removeData(sizeWithoutHeader),
                            hiddenQueue.shiftSegment()
                        );
                    }
                    else
                        promise = queue1.removeData(sizeWithoutHeader);

                    if (hasReached) {
                        return promise.then(function() {
                            return link.sendPacket();
                        });
                    }
                    else
                        return promise;
                }

                function runSymulation(currentTime, symulationTime) {
                    $('#time').text('Czas: ' + currentTime);
                    symulationStep().then(function() {
                        if (currentTime < symulationTime)
                            runSymulation(currentTime + 1, symulationTime);
                    })
                }

                runSymulation(0, 15);
            });
        </script>
    </head>
    <body>
        <div id='container'>
            <div id='time'>Czas: 1</div>
            <div id='source'>
                <div class='communication-participant'>
                    <div class='participant-name'>
                        Nadawca wiadomosci podstawowych<br>
                        Rozklad czasu pojawiania sie wiadomosci: <b>f(k<sub>1</sub>, &lambda;<sub>1</sub>)</b><br>
                        Rozklad dlugosci pojedynczej wiadomosci: <b>f(k<sub>2</sub>, &lambda;<sub>2</sub>)</b><br>
                    </div>
                    <svg class='icon' height="100" width="100">
                          <circle cx="50" cy="50" r="30" stroke="black" stroke-width="3" fill="red" />
                    </svg>
                    <div class='participant-queue-arrow'>
                        <i class="fa fa-arrow-down arrow-icon"></i>
                        <div class='process-step near-arrow'>1</div>
                    </div>
                </div>
                <div class='queue'>
                </div>
                <i class="fa fa-arrow-down queue-to-steganography-arrow"></i>
                <div class='steganography-unit'>
                    <svg width="200" height="200">
                          <rect x="90" y="-50" width="100" height="100" transform='rotate(45)'
                            style="fill:blue;stroke:pink;stroke-width:5;fill-opacity:0.1;stroke-opacity:0.9" />
                          <text x='40' y='105'>Fragmentacja</text>
                    </svg>
                    <div class='process-step' style='position:absolute; top: 75px; left: 185px;'>3</div>
                    <i class="fa fa-arrow-down steganography-to-network-arrow"></i>

                </div>

                <div class='network-stack'>
                    <table class='network-stack-table'>
                        <tr><td>UDP</td></tr>
                        <tr><td>IP</td></tr>
                        <tr><td>Ethernet</td></tr>
                    </table>
                    <div style='position: absolute; left: 100px; top: 150px; font-size: 16pt'>
                        <i class="fa fa-arrow-down"></i>
                        <div class='process-step near-arrow'>4</div>
                    </div>
                </div>
                <div id='secret-sender'>
                    <div id='hidden-message-queue'>
                        <div class='window-description'>Bity ukryte w pojednyczym pakiecie</div>
                        <div style='position: absolute; left: 235px; top: 150px;'>
                            <i class="fa fa-arrow-down"></i>
                            <div class='process-step near-arrow'>2</div>
                        </div>
                    </div>
                    <svg id='hidden-icon' height="100" width="100">
                          <circle cx="50" cy="50" r="30" stroke="black" stroke-width="3" fill="yellow" />
                    </svg>
                    <div id='hidden-message-sender-name'>
                        Nadawca wiadomosci ukrytych<br>
                        Rozklad czasu pojawiania sie wiadomosci: <b>f(k<sub>3</sub>, &lambda;<sub>3</sub>)</b><br>
                        Rozklad dlugosci pojedynczej wiadomosci: <b>f(k<sub>4</sub>, &lambda;<sub>4</sub>)</b><br>
                    </div>
                    <i class="fa fa-arrow-right hidden-arrow-icon"></i>
                </div>
            </div>

        </div>

            <div id='link'>
                <div class='description'>Kanal fizyczny ( Stopa bledow BER = 0% )</div>
                <hr/>
            </div>
            <div id='queues-desc'>
                <i class="fa fa-arrow-left"></i>
                <span class='capacity'>Pojemnosc: &infin;</span>
                <i class="fa fa-arrow-right"></i>
            </div>
            <div id='destination'>
                <div class='communication-participant'>
                    <div class='participant-name'>Odbiorca wiadomosci podstawowych</div>
                    <svg class='icon' height="100" width="100">
                          <circle cx="50" cy="50" r="30" stroke="black" stroke-width="3" fill="blue" />
                    </svg>
                    <div class='participant-queue-arrow'>
                        <i class="fa fa-arrow-up arrow-icon"></i>
                    </div>
                </div>
                <div class='queue'>
                </div>
                <i class="fa fa-arrow-up queue-to-steganography-arrow"></i>
                <div class='steganography-unit'>
                    <svg width="200" height="200">
                          <rect x="90" y="-50" width="100" height="100" transform='rotate(45)'
                            style="fill:blue;stroke:pink;stroke-width:5;fill-opacity:0.1;stroke-opacity:0.9" />
                          <text x='40' y='105'>Dekodowanie</text>
                    </svg>
                    <i class="fa fa-arrow-up steganography-to-network-arrow"></i>
                </div>
                <div class='network-stack'>
                    <table class='network-stack-table'>
                        <tr><td>UDP</td></tr>
                        <tr><td>IP</td></tr>
                        <tr><td>Ethernet</td></tr>
                    </table>
                </div>
                <div id='secret-receiver'>
                    <div id='hidden-message-queue'>
                    </div>
                    <svg id='hidden-icon' height="100" width="100">
                          <circle cx="50" cy="50" r="30" stroke="black" stroke-width="3" fill="white" />
                    </svg>
                    <div id='hidden-message-receiver-name'>Odbiorca wiadomosci ukrytych</div>
                    <i class="fa fa-arrow-right hidden-arrow-icon"></i>
                </div>
            </div>
            <div id='legend'>
                <div class='legend-header'>Opis protokolu kanalu ukrytego</div>
                <div class='step-description'>
                    <div class='process-step' style='float: left'>1</div>
                    <div class='step-content'> Czekaj na wiadomosc podstawowa. Dodaj ja do kolejki</div>
                </div>
                <div class='step-description'>
                    <div class='process-step' style='float: left'>2</div>
                    <div class='step-content'>Pobierz bity, ktore zostana ukryte w kolejnym pakiecie</div>
                </div>
                <div class='step-description'>
                    <div class='process-step' style='float: left'>3</div>
                    <div class='step-content'>Jesli kolejka wiadomosci podstawowych zawiera wiecej danych niz wartosc liczbowa danych ukrytych przejdz do 4, w przeciwnym wypadku wroc do 1</div>
                </div>
                <div class='step-description'>
                    <div class='process-step' style='float: left'>4</div>
                    <div class='step-content'>Wyslij pakiet o dlugosc dec(dane_do_ukrycia) bajtow</div>
                </div>
            </div>
        </div>
    </body>
</html>
